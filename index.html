<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    }
  });

  const INSTRUCTIONS = `
    <div>
      <p>Welcome to our experiment!</p>
      <p>In each trial, you will see a shape. Describe the shape as accurately as you can in the provided textbox.</p>
      <p></p>
      <p>The next page will ask for participant ID and some demographic information, then run a test trial.</p>
      <p></p>
      <p>Once you are ready to start, click any button.</p>
    </div>`;
  const TRIAL_PREAMBLE = "Describe the shape as accurately as you can.";
  const NUM_FIGURES_PDIFF = 7;

  // /* create timeline */
  var timeline = [];

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p" + random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
    random_id: random_id,
  });
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS


  // ---------- CREATE WELCOME PAGE ----------

  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: INSTRUCTIONS
  }
  timeline.push(welcome);


  // ---------- CREATE TEST TRIAL ----------
  // todo

  // ---------- DEFINE FIGURE CATEGORIES ----------

  function createStimulusDict(start, end, count, difficulty) {
    let fig_list = [];
    for (let i = start; i <= end; i++) {
      fig_list.push({
        figure: `stimuli/${i}.jpg`,
        difficulty: difficulty
      });
    }
    return jsPsych.randomization.sampleWithoutReplacement(fig_list, count)
  }

  const easy_stimuli = createStimulusDict(1, 25, NUM_FIGURES_PDIFF, "easy");
  const medium_stimuli = createStimulusDict(71, 95, NUM_FIGURES_PDIFF, "medium");
  const hard_stimuli = createStimulusDict(136, 160, NUM_FIGURES_PDIFF, "hard");


  // ---------- COMBINE/SHUFFLE FIGURES ----------

  const full_stimuli_list = jsPsych.randomization.shuffle([
    ...easy_stimuli, ...medium_stimuli, ...hard_stimuli
  ]);


  // ---------- PRELOAD IMAGES ----------

  var preload = {
    type: jsPsychPreload,
    images: full_stimuli_list.map(stimulus => stimulus.figure)
  };
  timeline.push(preload)


  // ---------- CREATE TRIALS ----------

  full_stimuli_list.forEach((stimulus) => {
    // make trial for each stimulus
    const trial = {
      type: jsPsychSurveyText,
      preamble: TRIAL_PREAMBLE,
      questions: [{
        prompt: `<div style="text-align:center;"><img src="${stimulus.figure}" style="width:300px;height:300px;"></div>`,
        name: "image_description",
        required: true,
        rows: 5
      }],
      data: {
        figure: stimulus.figure,
        difficulty: stimulus.difficulty
      },
      on_finish: function (data) {
        data.text_response = data.response["image_description"];
      }
    };
    timeline.push(trial)
  });

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //this portion of the code ensures that the data gets sent to be stored on OSF
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "VXiDzGQw8sUw",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };
  timeline.push(save_data);
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>