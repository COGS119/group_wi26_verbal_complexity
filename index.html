<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });

 const INSTRUCTIONS = `
    <div>
      <p>Welcome to our experiment!</p>
      <p>In each trial, you will see a shape. Describe the shape as accurately as you can in the provided textbox.</p>
      <p>The next page will run a test trial. Once you are ready to start, click any button.</p>
    </div>`;
  const TRIAL_PREAMBLE = "Describe the shape as accurately as you can.";
  const NUM_FIGURES_PDIFF = 4;

  // /* create timeline */
  var timeline = [];

  // /* create stimulus list */
  // // IDEA: each element in the array will be a dictionary so that we can concurrently store information about the correctness of the response
  // // MAIN TO DO: How can we expand this systematically to encompass all stimuli?

  // //create an example stimulus
  // // what kind of image characteristics might we want to store? (just a placeholder here)
  // stimulus_item = {
  //   image_name: "stimuli/1.jpg",
  //   image_characteristic: "XXX"
  // }

  // ---------- CREATE WELCOME PAGE ----------

  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: INSTRUCTIONS
  }
  timeline.push(welcome);

  // ---------- CREATE TEST TRIAL ----------
  // todo

  // ---------- DEFINE FIGURE CATEGORIES ----------

  function createStimulusDict(start, end, count, difficulty) {
    let fig_list = [];
    for (let i = start; i <= end; i++) {
      fig_list.push({
        figure: `stimuli/${i}.jpg`,
        difficulty: difficulty
      });
    }
    return jsPsych.randomization.sampleWithoutReplacement(fig_list, count)
  }

  const easy_stimuli = createStimulusDict(1, 20, NUM_FIGURES_PDIFF, "easy");
  const medium_stimuli = createStimulusDict(71, 90, NUM_FIGURES_PDIFF, "medium");
  const hard_stimuli = createStimulusDict(141, 160, NUM_FIGURES_PDIFF, "hard");

  // ---------- COMBINE/SHUFFLE FIGURES ----------

  const full_stimuli_list = jsPsych.randomization.shuffle([
    ...easy_stimuli, ...medium_stimuli, ...hard_stimuli
  ]);

  // ---------- PRELOAD IMAGES ----------

  var preload = {
    type: jsPsychPreload,
    images: full_stimuli_list.map(stimulus => stimulus.figure)
  };
  timeline.push(preload)
  
  // // here's how we can construct a simple description trial
  // // OTHER TO DOs: what else do we need to add to the trial procedure? What other information should we store? How can we turn this into a complete experiment timeline?
  // var trial = {
  //       type: jsPsychSurveyText,
  //       preamble: "<p>Describe what you see on the screen.<\p>",
  //       //check out the plugin to understand how we are using the question parameters below
  //       questions: [{prompt: '<img src='+stimulus_item["image_name"]+' style="width:300px;height:300px;">',rows:5, columns:50,name:"image_description", required: true}],
  //       data: {image_characteristic: stimulus_item['image_characteristic']},
  //       //extracting the text response - this will just make it a little easier when processing the data (because otherwise it is nested)
  //       on_finish: function (data) {
  //         data.text_response = data.response["image_description"];
  //         console.log(data)
  //       }
  //     }

  // timeline.push(trial);

  // ---------- CREATE TRIALS ----------

  full_stimuli_list.forEach((stimulus) => {
    // make trial for each stimulus
    const trial = {
      type: jsPsychSurveyText,
      preamble: TRIAL_PREAMBLE,
      questions: [{
        prompt: `<div style="text-align:center;"><img src="${stimulus.figure}" style="width:300px;height:300px;"></div>`,
        name: "image_description",
        required: true,
        rows: 5
      }],
      data: {
        figure: stimulus.figure,
        difficulty: stimulus.difficulty
      },
      on_finish: function(data) {
        data.text_response = data.response["image_description"];
      }
    };
    timeline.push(trial)
  });

  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>