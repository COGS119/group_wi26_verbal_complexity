<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.2.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych();

  const INSTRUCTIONS = `
    <div>
      <p>Welcome to our experiment!</p>
      <p>In each trial, you will see a shape. Describe the shape as accurately as you can in the provided textbox.</p>
      <p>Your description can be as long or as short as you’d like, from just a few words up to a whole paragraph if you feel that is necessary.</p>
      <p></p>
      <p>The next page will ask for participant ID.</p>
      <p></p>
      <p>After all the trials have been completed, the last page will ask for some demographic information.</p>
      <p></p>
      <p>Once you are ready to start, click any button.</p>
    </div>`;
  const TRIAL_PREAMBLE = "Describe the shape as accurately as you can.";
  const DEBRIEF = 
      `<p>Thank you for taking the time to run our experiment!</p>
      <p>The goal of our tests is to find how object complexity translates in a mental capacity.</p>
      <p>We are counting the amount of words you typed to see if there’s a correlation between description length and complexity of the shape.</p>
      <p>However, we were also recording the amount of time you took to write your responses </p>
      <p>to observe if there exists an additional relationship between time and complexity.</p>
      <p>Click any button to exit the experiment </p>`
  const TEST_FIGURE = "stimuli/27.jpg"
  const TOTAL_FIGURES = 160
  const TRIALS_P_PARTICIPANT = 20
  const NUM_TRIAL_GROUPS = TOTAL_FIGURES / TRIALS_P_PARTICIPANT

  // /* create timeline */
  var timeline = [];
  timeline.push({
    type: jsPsychFullscreen,
    fullscreen_mode: true
  })

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p" + random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
    random_id: random_id,
  });

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS


  // ---------- CREATE WELCOME PAGE ----------

  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: INSTRUCTIONS
  }
  timeline.push(welcome);

  // ---------- PARTICIPANT ID ----------

  var participant_id_entry = {
    type: jsPsychSurveyText,
    questions: [{
      prompt: "Please enter your participant ID.", name: "participant_id", required: true}],
    on_finish: function (data) {
      console.log(data.response)
      jsPsych.data.addProperties({
        participant: data.response.participant_id
      });
    }
  };

  timeline.push(participant_id_entry);

  // ---------- DEFINE FIGURE CATEGORIES ----------

  function range(start, end, step = 1) {
    const length = Math.floor((end - start) / step) + 1;
    return Array.from({ length }, (_, i) => start + i * step);
  }

  function getDifficulty(imageNumber) {
    if (imageNumber <= 53) return "easy";
    if (imageNumber <= 106) return "medium";
    return "hard";
  }

  const stimulus_groups = [
    range(1, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(2, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(3, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(4, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(5, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(6, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(7, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
    range(8, TOTAL_FIGURES, NUM_TRIAL_GROUPS),
  ];

  const selected_group = jsPsych.randomization.sampleWithoutReplacement(stimulus_groups, 1)[0];
  
  const current_stimulus_list = selected_group.map(n => ({
    figure: `stimuli/${n}.jpg`,
    difficulty: getDifficulty(n)
  }));

  const shuffled_stimuli = jsPsych.randomization.shuffle(current_stimulus_list);


  // ---------- PRELOAD IMAGES ----------

  var preload = {
    type: jsPsychPreload,
    images: [TEST_FIGURE, ...shuffled_stimuli.map(stimulus => stimulus.figure)]
  };
  timeline.push(preload)

  // ---------- CREATE TRIALS ----------

  shuffled_stimuli.forEach((stimulus) => {
    // make trial for each stimulus
    let trial_start_time;
    const trial = {
      type: jsPsychSurveyText,
      preamble: TRIAL_PREAMBLE,
      questions: [{
        prompt: `<div style="text-align:center;"><img src="${stimulus.figure}" style="width:300px;height:300px;"></div>`,
        name: "image_description",
        required: true,
        rows: 5
      }],
      data: {
        figure: stimulus.figure,
        difficulty: stimulus.difficulty
      },
      on_finish: function(data) {
        data.response_time_seconds = (performance.now() - trial_start_time) / 1000;
        data.text_response = data.response["image_description"];
        const words = data.text_response.trim().split(/\s+/);
        const wordCount = words.length;
        data.word_count = wordCount;
      }
    };

    timeline.push(trial);
  });

  // ---------- GET DEMOGRAPHIC INFORMATION ----------

  // Gets participant major and stores
  var participant_major = {
    type: jsPsychSurveyText,
    questions: [{ prompt: "Please enter your major:", name: "participant_major", required: true}],
    on_finish: function (data) {
      console.log(data.response)
      jsPsych.data.addProperties({
        participant: data.response.participant_id
      });
    }
  }
  timeline.push(participant_major);

  // ------ Get participant gender ------
  var participant_gender = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Please select your gender:",
      name: "participant_gender",
      options: [
        "Female",
        "Male",
        "Non-binary",
        "Other"
      ],
      required: true
    }
  ],
  on_finish: function (data) {
    console.log(data.response);
    jsPsych.data.addProperties({
      participant_gender: data.response.participant_id
    });
  }
};
timeline.push(participant_gender);

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //this portion of the code ensures that the data gets sent to be stored on OSF
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "VXiDzGQw8sUw",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };
  timeline.push(save_data);
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS


  // ---------- CREATED DEBRIEF ----------
  var debrief = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: DEBRIEF
  }
  timeline.push(debrief);
  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>
